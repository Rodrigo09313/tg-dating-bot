----- docker/initdb/001_extensions.sql
CREATE EXTENSION IF NOT EXISTS postgis;
CREATE EXTENSION IF NOT EXISTS cube;

----- docker/initdb/010_schema.sql
CREATE TABLE IF NOT EXISTS browse_seen (
  user_id      BIGINT NOT NULL,
  seen_user_id BIGINT NOT NULL,
  ts           TIMESTAMPTZ NOT NULL DEFAULT now(),
  CONSTRAINT browse_seen_pk PRIMARY KEY (user_id, seen_user_id),
  CONSTRAINT browse_seen_user_fk  FOREIGN KEY (user_id)      REFERENCES users(tg_id) ON DELETE CASCADE,
  CONSTRAINT browse_seen_seen_fk  FOREIGN KEY (seen_user_id) REFERENCES users(tg_id) ON DELETE CASCADE
);
CREATE INDEX IF NOT EXISTS browse_seen_user_ts_idx ON browse_seen(user_id, ts DESC);

----- docker/initdb/020_contact_core.sql
CREATE TABLE IF NOT EXISTS contact_requests (
  id          BIGSERIAL PRIMARY KEY,
  from_id     BIGINT NOT NULL REFERENCES users(tg_id) ON DELETE CASCADE,
  to_id       BIGINT NOT NULL REFERENCES users(tg_id) ON DELETE CASCADE,
  context     TEXT   NOT NULL CHECK (context IN ('browse','roulette')),
  status      TEXT   NOT NULL DEFAULT 'pending' CHECK (status IN ('pending','accepted','declined')),
  created_at  TIMESTAMPTZ NOT NULL DEFAULT now(),
  decided_at  TIMESTAMPTZ
);
CREATE UNIQUE INDEX IF NOT EXISTS cr_pair_pending_uq
ON contact_requests (LEAST(from_id,to_id), GREATEST(from_id,to_id))
WHERE status = 'pending';
CREATE INDEX IF NOT EXISTS cr_to_idx   ON contact_requests (to_id,  status, created_at DESC);
CREATE INDEX IF NOT EXISTS cr_from_idx ON contact_requests (from_id, status, created_at DESC);

CREATE TABLE IF NOT EXISTS contacts (
  id          BIGSERIAL PRIMARY KEY,
  a_id        BIGINT NOT NULL REFERENCES users(tg_id) ON DELETE CASCADE,
  b_id        BIGINT NOT NULL REFERENCES users(tg_id) ON DELETE CASCADE,
  created_at  TIMESTAMPTZ NOT NULL DEFAULT now(),
  CONSTRAINT contacts_self_chk CHECK (a_id <> b_id)
);
CREATE UNIQUE INDEX IF NOT EXISTS contacts_pair_uq
ON contacts (LEAST(a_id,b_id), GREATEST(a_id,b_id));
CREATE INDEX IF NOT EXISTS contacts_a_idx ON contacts (a_id, created_at DESC);
CREATE INDEX IF NOT EXISTS contacts_b_idx ON contacts (b_id, created_at DESC);

